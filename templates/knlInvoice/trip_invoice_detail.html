{% extends 'partials/base.html' %}
{% load static %}

{% block title %}Invoice {{ invoice.invoice_number }} - Kamrate{% endblock %}

{% block content %}
<main>
  <div class="page-header">
    <div>
      <h1>üìÑ {{ invoice.invoice_number }}</h1>
      <p class="text-muted">Client: <strong>{{ invoice.client.clientName|default:"No Client" }}</strong></p>
    </div>
    <div class="btn-group">
      <a href="{% url 'knlInvoice:trip-invoice-list' %}" class="btn btn-outline-secondary">
        üìã Back to List
      </a>
    </div>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <!-- Action Buttons -->
  <div class="card mb-4" style="border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
    <div class="card-body p-3">
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <a href="{% url 'knlInvoice:trip-invoice-edit' pk=invoice.pk %}" class="btn btn-primary" style="background-color: var(--kamrate-orange); border-color: var(--kamrate-orange);">
          ‚úèÔ∏è Edit Invoice
        </a>
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#paymentModal">
          üí∞ Record Payment
        </button>
        <a href="{% url 'knlInvoice:trip-invoice-send' pk=invoice.pk %}" class="btn btn-info">
          ‚úâÔ∏è Mark as Sent
        </a>
        <a href="{% url 'knlInvoice:trip-invoice-delete' pk=invoice.pk %}" class="btn btn-outline-danger">
          üóëÔ∏è Delete
        </a>
      </div>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card" style="border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div class="card-body">
          <h6 class="text-muted mb-2" style="font-weight: 700;">Status</h6>
          <p style="margin: 0;">
            <span class="badge" style="background-color: 
              {% if invoice.status == 'draft' %}#808080
              {% elif invoice.status == 'sent' %}#0099ff
              {% elif invoice.status == 'pending' %}#ff6600
              {% elif invoice.status == 'paid' %}#00cc00
              {% elif invoice.status == 'overdue' %}#ff0000
              {% else %}#999999{% endif %}; padding: 8px 12px; font-size: 0.9rem;">
              {{ invoice.get_status_display }}
            </span>
          </p>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card" style="border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div class="card-body">
          <h6 class="text-muted mb-2" style="font-weight: 700;">Total Due</h6>
          <h4 style="margin: 0; color: var(--kamrate-blue); font-weight: 800;">‚Ç¶{{ invoice.total|floatformat:2 }}</h4>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card" style="border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div class="card-body">
          <h6 class="text-muted mb-2" style="font-weight: 700;">Amount Paid</h6>
          <h4 style="margin: 0; color: #0D7A3D; font-weight: 800;">‚Ç¶{{ invoice.amount_paid|floatformat:2 }}</h4>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card" style="border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div class="card-body">
          <h6 class="text-muted mb-2" style="font-weight: 700;">Outstanding</h6>
          <h4 style="margin: 0; color: #dc3545; font-weight: 800;">‚Ç¶{{ invoice.outstanding_amount|floatformat:2 }}</h4>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Left: Invoice Details -->
    <div class="col-lg-6">
      <!-- Invoice Information -->
      <div class="card mb-4" style="border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div class="card-header" style="background-color: #f8f9fa; border-bottom: 2px solid var(--kamrate-orange); padding: 15px 20px;">
          <h5 style="color: var(--kamrate-blue); font-weight: 800; margin: 0;">Invoice Details</h5>
        </div>
        <div class="card-body p-4">
          <div class="mb-3">
            <small class="text-muted" style="font-weight: 700;">INVOICE NUMBER</small>
            <p style="margin: 5px 0; color: var(--kamrate-blue); font-weight: 800;">{{ invoice.invoice_number }}</p>
          </div>
          <hr>
          <div class="mb-3">
            <small class="text-muted" style="font-weight: 700;">ISSUE DATE</small>
            <p style="margin: 5px 0; font-weight: 600;">{{ invoice.issue_date|date:"d M Y" }}</p>
          </div>
          <hr>
          <div class="mb-3">
            <small class="text-muted" style="font-weight: 700;">DUE DATE</small>
            <p style="margin: 5px 0; font-weight: 600;">
              {% if invoice.due_date %}
                {{ invoice.due_date|date:"d M Y" }}
              {% else %}
                <span class="text-muted">Not set</span>
              {% endif %}
            </p>
          </div>
          <hr>
          <div class="mb-0">
            <small class="text-muted" style="font-weight: 700;">PAYMENT TERMS</small>
            <p style="margin: 5px 0; font-weight: 600;">{{ invoice.get_payment_terms_display }}</p>
          </div>
        </div>
      </div>

      <!-- Client Information -->
      <div class="card" style="border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div class="card-header" style="background-color: #f8f9fa; border-bottom: 2px solid var(--kamrate-orange); padding: 15px 20px;">
          <h5 style="color: var(--kamrate-blue); font-weight: 800; margin: 0;">Client Information</h5>
        </div>
        <div class="card-body p-4">
          {% if invoice.client %}
            <div class="mb-3">
              <small class="text-muted" style="font-weight: 700;">COMPANY NAME</small>
              <p style="margin: 5px 0; font-weight: 600;">{{ invoice.client.clientName }}</p>
            </div>
            <hr>
            <div class="mb-3">
              <small class="text-muted" style="font-weight: 700;">EMAIL</small>
              <p style="margin: 5px 0;">
                <a href="mailto:{{ invoice.client.emailAddress }}">{{ invoice.client.emailAddress }}</a>
              </p>
            </div>
            <hr>
            <div class="mb-3">
              <small class="text-muted" style="font-weight: 700;">PHONE</small>
              <p style="margin: 5px 0;">
                <a href="tel:{{ invoice.client.phoneNumber }}">{{ invoice.client.phoneNumber }}</a>
              </p>
            </div>
            <hr>
            <div class="mb-0">
              <small class="text-muted" style="font-weight: 700;">ADDRESS</small>
              <p style="margin: 5px 0;">{{ invoice.client.addressLine1 }}, {{ invoice.client.state }}</p>
            </div>
          {% else %}
            <p class="text-muted">No client assigned</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Right: Financial & Containers -->
    <div class="col-lg-6">
      <!-- Financial Summary -->
      <div class="card mb-4" style="border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div class="card-header" style="background-color: #f8f9fa; border-bottom: 2px solid var(--kamrate-orange); padding: 15px 20px;">
          <h5 style="color: var(--kamrate-blue); font-weight: 800; margin: 0;">Financial Summary</h5>
        </div>
        <div class="card-body p-4">
          <div class="mb-3" style="display: flex; justify-content: space-between;">
            <span class="text-muted" style="font-weight: 600;">Subtotal:</span>
            <strong>‚Ç¶{{ invoice.subtotal|floatformat:2 }}</strong>
          </div>
          <div class="mb-3" style="display: flex; justify-content: space-between;">
            <span class="text-muted" style="font-weight: 600;">Tax ({{ invoice.tax_rate }}%):</span>
            <strong style="color: var(--kamrate-orange);">‚Ç¶{{ invoice.tax_amount|floatformat:2 }}</strong>
          </div>
          <hr>
          <div class="mb-4" style="display: flex; justify-content: space-between; font-size: 1.2rem;">
            <strong style="color: var(--kamrate-blue); font-weight: 800;">TOTAL:</strong>
            <strong style="color: #0D7A3D; font-weight: 800;">‚Ç¶{{ invoice.total|floatformat:2 }}</strong>
          </div>
          <hr>
          <div class="mb-3" style="display: flex; justify-content: space-between;">
            <span class="text-success" style="font-weight: 600;">Amount Paid:</span>
            <strong style="color: #0D7A3D;">‚Ç¶{{ invoice.amount_paid|floatformat:2 }}</strong>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span class="text-warning" style="font-weight: 600;">Outstanding:</span>
            <strong style="color: #dc3545;">‚Ç¶{{ invoice.outstanding_amount|floatformat:2 }}</strong>
          </div>
        </div>
      </div>

      <!-- Containers -->
      <div class="card" style="border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div class="card-header" style="background-color: #f8f9fa; border-bottom: 2px solid var(--kamrate-orange); padding: 15px 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <h5 style="color: var(--kamrate-blue); font-weight: 800; margin: 0;">Containers ({{ invoice.line_items.count }})</h5>
            {% if invoice.status == 'draft' %}
            <a href="{% url 'knlInvoice:trip-invoice-add-trip' pk=invoice.pk %}" class="btn btn-sm btn-primary">
              ‚ûï Add
            </a>
            {% endif %}
          </div>
        </div>
        <div class="card-body p-0">
          {% if invoice.line_items.all %}
            <div class="table-responsive">
              <table class="table table-sm mb-0">
                <thead style="background-color: #f8f9fa;">
                  <tr>
                    <th style="padding: 12px;">Container</th>
                    <th style="padding: 12px;">Destination</th>
                    <th style="padding: 12px;">Amount</th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in invoice.line_items.all %}
                  <tr style="border-bottom: 1px solid #e9ecef;">
                    <td style="padding: 12px;"><strong>{{ item.container_number }}</strong></td>
                    <td style="padding: 12px;">{{ item.destination }}</td>
                    <td style="padding: 12px;"><strong style="color: #0D7A3D;">‚Ç¶{{ item.amount|floatformat:2 }}</strong></td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="alert alert-info m-3">No containers yet. <a href="{% url 'knlInvoice:trip-invoice-add-trip' pk=invoice.pk %}">Add one now</a>!</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Payment Records -->
  {% if invoice.payments.all %}
  <div class="card mt-4" style="border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
    <div class="card-header" style="background-color: #f8f9fa; border-bottom: 2px solid var(--kamrate-orange); padding: 15px 20px;">
      <h5 style="color: var(--kamrate-blue); font-weight: 800; margin: 0;">Payment Records</h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm mb-0">
          <thead style="background-color: #f8f9fa;">
            <tr>
              <th style="padding: 12px;">Date</th>
              <th style="padding: 12px;">Amount</th>
              <th style="padding: 12px;">Method</th>
              <th style="padding: 12px;">Reference</th>
            </tr>
          </thead>
          <tbody>
            {% for payment in invoice.payments.all %}
            <tr style="border-bottom: 1px solid #e9ecef;">
              <td style="padding: 12px;">{{ payment.payment_date|date:"d M Y" }}</td>
              <td style="padding: 12px;"><strong style="color: #0D7A3D;">‚Ç¶{{ payment.amount|floatformat:2 }}</strong></td>
              <td style="padding: 12px;">{{ payment.get_payment_method_display }}</td>
              <td style="padding: 12px;">{{ payment.reference_number|default:"-" }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Notes -->
  {% if invoice.notes %}
  <div class="card mt-4" style="border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
    <div class="card-header" style="background-color: #f8f9fa; border-bottom: 2px solid var(--kamrate-orange); padding: 15px 20px;">
      <h5 style="color: var(--kamrate-blue); font-weight: 800; margin: 0;">Notes</h5>
    </div>
    <div class="card-body p-4">
      <p style="margin: 0; color: #333;">{{ invoice.notes }}</p>
    </div>
  </div>
  {% endif %}
</main>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header" style="background-color: var(--kamrate-orange); color: white;">
        <h5 class="modal-title" style="font-weight: 800;">üí∞ Record Payment</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="{% url 'knlInvoice:trip-invoice-record-payment' pk=invoice.pk %}">
        {% csrf_token %}
        <div class="modal-body p-4">
          <div class="mb-3">
            <label for="amount" class="form-label" style="font-weight: 600;">Amount (‚Ç¶) *</label>
            <input type="number" class="form-control" id="amount" name="amount" step="0.01" required placeholder="0.00" style="border: 1px solid #ddd; border-radius: 5px; padding: 10px;">
            <small class="text-muted">Outstanding: ‚Ç¶{{ invoice.outstanding_amount|floatformat:2 }}</small>
          </div>

          <div class="mb-3">
            <label for="payment_method" class="form-label" style="font-weight: 600;">Payment Method *</label>
            <select class="form-select" id="payment_method" name="payment_method" required style="border: 1px solid #ddd; border-radius: 5px; padding: 10px;">
              <option value="bank_transfer">Bank Transfer</option>
              <option value="cash">Cash</option>
              <option value="cheque">Cheque</option>
              <option value="online">Online Payment</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="reference_number" class="form-label" style="font-weight: 600;">Reference Number</label>
            <input type="text" class="form-control" id="reference_number" name="reference_number" placeholder="e.g., Transaction ID" style="border: 1px solid #ddd; border-radius: 5px; padding: 10px;">
          </div>

          <div class="mb-0">
            <label for="notes" class="form-label" style="font-weight: 600;">Notes</label>
            <textarea class="form-control" id="notes" name="notes" rows="3" style="border: 1px solid #ddd; border-radius: 5px; padding: 10px;"></textarea>
          </div>
        </div>
        <div class="modal-footer p-3" style="border-top: 1px solid #e9ecef;">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">‚úì Record Payment</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}