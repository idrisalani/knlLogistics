{% extends 'partials/base.html' %}
{% load static %}

{% block title %}Add Expense - Kamrate{% endblock %}

{% block content %}
<main>
  <!-- Page Header -->
  <div class="page-header">
    <div>
      <h1>‚ûï Add Expense</h1>
      <p class="text-muted">{{ trip.origin }} ‚Üí {{ trip.destination }}</p>
    </div>
    <div class="btn-group">
      <a href="{% url 'knlInvoice:trip-detail' pk=trip.pk %}" class="btn btn-outline-secondary">
        ‚Üê Back to Trip
      </a>
    </div>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <div class="row">
    <!-- Left: Form (8 cols) -->
    <div class="col-lg-8">
      <!-- Trip Summary Card -->
      <div class="card mb-4" style="border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-top: 4px solid var(--kamrate-orange);">
        <div class="card-header" style="background-color: #f8f9fa; border-bottom: 2px solid #e9ecef; padding: 20px;">
          <h5 style="color: var(--kamrate-blue); font-weight: 800; margin: 0;">
            üöö Trip: {{ trip.tripNumber }}
          </h5>
        </div>
        <div class="card-body p-4">
          <div class="row mb-4">
            <div class="col-md-6">
              <small class="text-muted" style="font-weight: 700;">TRIP DATE</small>
              <p style="margin: 8px 0; color: #333; font-weight: 600;">
                {{ trip.startDate|date:"d M Y" }}
              </p>
            </div>
            <div class="col-md-6">
              <small class="text-muted" style="font-weight: 700;">TRIP REVENUE</small>
              <p style="margin: 8px 0; color: #0D7A3D; font-weight: 800; font-size: 1.1rem;">
                ‚Ç¶{{ total_revenue|floatformat:2 }}
              </p>
            </div>
          </div>

          <hr style="margin: 15px 0; border-top: 1px solid #e9ecef;">

          <div class="row">
            <div class="col-md-6">
              <small class="text-muted" style="font-weight: 700;">CURRENT EXPENSES</small>
              <p style="margin: 8px 0; color: var(--kamrate-orange); font-weight: 800; font-size: 1.1rem;">
                ‚Ç¶{{ total_expenses|floatformat:2 }}
              </p>
            </div>
            <div class="col-md-6">
              <small class="text-muted" style="font-weight: 700;">CURRENT STATUS</small>
              {% if profit >= 0 %}
                <p style="margin: 8px 0; color: #0D7A3D; font-weight: 800; font-size: 1.1rem;">
                  ‚úì Profit: ‚Ç¶{{ profit|floatformat:2 }}
                </p>
              {% else %}
                <p style="margin: 8px 0; color: #dc3545; font-weight: 800; font-size: 1.1rem;">
                  ‚ùå Loss: ‚Ç¶{{ profit|floatformat:2 }}
                </p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Expense Form Card -->
      <div class="card" style="border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div class="card-header" style="background-color: #f8f9fa; border-bottom: 2px solid var(--kamrate-orange); padding: 20px;">
          <h5 style="color: var(--kamrate-blue); font-weight: 800; margin: 0;">
            üìù Expense Details
          </h5>
        </div>

        <div class="card-body p-4">
          <form method="POST">
            {% csrf_token %}

            <!-- Section 1: Amount -->
            <fieldset class="mb-4" style="border: none; padding: 0;">
              <h6 style="color: var(--kamrate-blue); font-weight: 700; margin-bottom: 20px;">
                üí∞ Expense Amount
              </h6>

              <div class="mb-3">
                <label for="id_amount" class="form-label" style="font-weight: 600;">
                  Amount (‚Ç¶) <span class="text-danger">*</span>
                </label>
                <div class="input-group">
                  <span class="input-group-text" style="background-color: #f8f9fa; border: 1px solid #ddd;">‚Ç¶</span>
                  <input 
                    type="number" 
                    class="form-control" 
                    id="id_amount" 
                    name="amount" 
                    placeholder="5000.00" 
                    step="0.01" 
                    min="0.01"
                    required
                    style="border: 1px solid #ddd; border-radius: 0 5px 5px 0;"
                  />
                </div>
                <small class="text-muted">How much is this expense?</small>
              </div>
            </fieldset>

            <!-- Section 2: Date & Type -->
            <fieldset class="mb-4" style="border: none; padding: 0;">
              <h6 style="color: var(--kamrate-blue); font-weight: 700; margin-bottom: 20px;">
                üìã Expense Information
              </h6>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="id_date" class="form-label" style="font-weight: 600;">
                    Expense Date <span class="text-danger">*</span>
                  </label>
                  <input 
                    type="datetime-local" 
                    class="form-control" 
                    id="id_date" 
                    name="date" 
                    required
                    style="border: 1px solid #ddd; border-radius: 5px; padding: 10px;"
                  />
                  <small class="text-muted">When was this expense incurred?</small>
                </div>

                <div class="col-md-6">
                  <label for="id_expenseType" class="form-label" style="font-weight: 600;">
                    Expense Type <span class="text-danger">*</span>
                  </label>
                  <select class="form-select" id="id_expenseType" name="expenseType" required style="border: 1px solid #ddd; border-radius: 5px; padding: 10px;">
                    <option value="">-- Select Expense Type --</option>
                    {% for value, label in expense_types %}
                      <option value="{{ value }}">{{ label }}</option>
                    {% endfor %}
                  </select>
                  <small class="text-muted">What type of expense?</small>
                </div>
              </div>

              <div class="mb-3">
                <label for="id_description" class="form-label" style="font-weight: 600;">
                  Description <span class="text-danger">*</span>
                </label>
                <input 
                  type="text" 
                  class="form-control" 
                  id="id_description" 
                  name="description" 
                  placeholder="e.g., Fuel at Lagos, Vehicle maintenance"
                  required
                  style="border: 1px solid #ddd; border-radius: 5px; padding: 10px;"
                />
                <small class="text-muted">Brief description of the expense</small>
              </div>

              <div class="mb-0">
                <label for="id_notes" class="form-label" style="font-weight: 600;">
                  Notes <span class="text-muted">(Optional)</span>
                </label>
                <textarea 
                  class="form-control" 
                  id="id_notes" 
                  name="notes" 
                  rows="3" 
                  placeholder="Add any additional information"
                  style="border: 1px solid #ddd; border-radius: 5px; padding: 10px;"
                ></textarea>
                <small class="text-muted">Add any additional information</small>
              </div>
            </fieldset>

            <!-- Action Buttons -->
            <div class="mt-4 pt-3" style="border-top: 1px solid #e9ecef;">
              <div style="display: flex; gap: 10px;">
                <button 
                  type="submit" 
                  class="btn btn-primary" 
                  style="background-color: var(--kamrate-orange); border-color: var(--kamrate-orange); font-weight: 700; padding: 12px 30px; border-radius: 5px;">
                  ‚úì Add Expense
                </button>
                <a 
                  href="{% url 'knlInvoice:trip-detail' pk=trip.pk %}" 
                  class="btn btn-outline-secondary" 
                  style="font-weight: 700; padding: 12px 30px; border-radius: 5px;">
                  ‚úï Cancel
                </a>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Help Tip -->
      <div class="alert alert-info mt-4" style="border: none; background-color: #d1ecf1; border-radius: 8px; padding: 15px;">
        <i class="fas fa-lightbulb"></i>
        <strong>üí° Tip:</strong> Record all expenses for accurate trip profitability. The system will automatically recalculate trip profit after you add this expense.
      </div>
    </div>

    <!-- Right: Quick Info (4 cols) -->
    <div class="col-lg-4">
      <!-- Current Status Card (Sticky) -->
      <div class="card" style="border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: sticky; top: 20px;">
        <div class="card-header" style="background-color: #f8f9fa; border-bottom: 2px solid var(--kamrate-orange); padding: 20px;">
          <h5 style="color: var(--kamrate-blue); font-weight: 800; margin: 0;">
            üìä Current Status
          </h5>
        </div>
        <div class="card-body p-4">
          <div class="mb-4 pb-4" style="border-bottom: 1px solid #e9ecef;">
            <small class="text-muted" style="font-weight: 700;">REVENUE</small>
            <h5 style="margin: 8px 0; color: #0D7A3D; font-weight: 800;">‚Ç¶{{ total_revenue|floatformat:2 }}</h5>
          </div>

          <div class="mb-4 pb-4" style="border-bottom: 1px solid #e9ecef;">
            <small class="text-muted" style="font-weight: 700;">EXPENSES</small>
            <h5 style="margin: 8px 0; color: var(--kamrate-orange); font-weight: 800;">‚Ç¶{{ total_expenses|floatformat:2 }}</h5>
          </div>

          <div class="mb-4">
            {% if profit >= 0 %}
              <small class="text-success" style="font-weight: 700;">NET PROFIT</small>
              <h5 style="margin: 8px 0; color: #0D7A3D; font-weight: 800;">‚úì ‚Ç¶{{ profit|floatformat:2 }}</h5>
              <small class="text-success">üòä Profitable Trip</small>
            {% else %}
              <small class="text-danger" style="font-weight: 700;">TOTAL LOSS</small>
              <h5 style="margin: 8px 0; color: #dc3545; font-weight: 800;">‚ùå ‚Ç¶{{ profit|floatformat:2 }}</h5>
              <small class="text-danger">üòû Loss-Making Trip</small>
            {% endif %}
          </div>

          <hr style="margin: 15px 0; border-top: 1px solid #e9ecef;">

          <p class="text-muted text-center" style="font-size: 0.85rem;">
            <strong>Tip:</strong> Adding this expense will update the trip profit calculation.
          </p>
        </div>
      </div>
    </div>
  </div>
</main>

<style>
  /* Form styling */
  .form-control, .form-select {
    transition: all 0.3s ease;
  }

  .form-control:focus, .form-select:focus {
    border-color: var(--kamrate-orange) !important;
    box-shadow: 0 0 0 3px rgba(255, 149, 0, 0.15) !important;
  }

  /* Responsive adjustments */
  @media (max-width: 992px) {
    .card {
      position: static !important;
      margin-bottom: 20px;
    }
  }

  @media (max-width: 768px) {
    .input-group-text {
      border-radius: 5px 0 0 5px;
    }

    .form-control {
      border-radius: 0 5px 5px 0;
    }
  }
</style>

<script>
  // Set default datetime to now
  document.addEventListener('DOMContentLoaded', function() {
    const dateField = document.getElementById('id_date');
    if (dateField && !dateField.value) {
      const now = new Date();
      now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
      dateField.value = now.toISOString().slice(0, 16);
    }
  });
</script>
{% endblock %}