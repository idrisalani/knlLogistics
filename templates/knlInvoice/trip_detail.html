{% extends 'partials/base.html' %}
{% load static %}

{% block title %}{{ trip.tripNumber }} - Trip Details - Kamrate{% endblock %}

{% block content %}
<main>
  <!-- Page Header -->
  <div class="page-header">
    <div>
      <h1>üöö {{ trip.tripNumber }}</h1>
      <p class="text-muted">{{ trip.origin }} ‚Üí {{ trip.destination }}</p>
    </div>
    <div class="btn-group">
      <a href="{% url 'knlInvoice:trips-list' %}" class="btn btn-outline-secondary">
        ‚Üê Back to Trips
      </a>
      <a href="{% url 'knlInvoice:trip-update' pk=trip.pk %}" class="btn btn-primary" style="background-color: var(--kamrate-orange); border-color: var(--kamrate-orange); font-weight: 700;">
        ‚úèÔ∏è Edit Trip
      </a>
    </div>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <div class="row">
    <!-- Left Column: Trip Details & Expenses (8 cols) -->
    <div class="col-lg-8">
      <!-- Trip Information Card -->
      <div class="card mb-4" style="border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-top: 4px solid var(--kamrate-orange);">
        <div class="card-header" style="background-color: #f8f9fa; border-bottom: 2px solid #e9ecef; padding: 20px;">
          <h5 style="color: var(--kamrate-blue); font-weight: 800; margin: 0;">
            ‚ÑπÔ∏è Trip Information
          </h5>
        </div>
        <div class="card-body p-4">
          <div class="row">
            <div class="col-md-6 mb-4">
              <small class="text-muted" style="font-weight: 700;">TRIP DATE</small>
              <p style="margin: 8px 0; color: var(--kamrate-blue); font-weight: 800; font-size: 1.1rem;">
                {{ trip.startDate|date:"d M Y" }}
              </p>
            </div>
            <div class="col-md-6 mb-4">
              <small class="text-muted" style="font-weight: 700;">STATUS</small>
              <p style="margin: 8px 0;">
                {% if trip.status == 'COMPLETED' %}
                  <span class="badge" style="background-color: #0D7A3D; color: white; padding: 8px 12px; font-weight: 600;">‚úì Completed</span>
                {% elif trip.status == 'IN_PROGRESS' %}
                  <span class="badge" style="background-color: var(--kamrate-orange); color: white; padding: 8px 12px; font-weight: 600;">‚ü≥ In Progress</span>
                {% elif trip.status == 'PENDING' %}
                  <span class="badge" style="background-color: #95a5a6; color: white; padding: 8px 12px; font-weight: 600;">‚è≥ Pending</span>
                {% else %}
                  <span class="badge" style="background-color: #95a5a6; color: white; padding: 8px 12px; font-weight: 600;">{{ trip.status }}</span>
                {% endif %}
              </p>
            </div>
          </div>

          <hr style="margin: 15px 0; border-top: 1px solid #e9ecef;">

          <div class="row">
            <div class="col-md-6 mb-4">
              <small class="text-muted" style="font-weight: 700;">TRUCK</small>
              <p style="margin: 8px 0; color: var(--kamrate-blue); font-weight: 800;">
                {% if trip.truck %}
                  {{ trip.truck.plateNumber }}
                {% else %}
                  <span class="text-muted">Not assigned</span>
                {% endif %}
              </p>
            </div>
            <div class="col-md-6 mb-0">
              <small class="text-muted" style="font-weight: 700;">CARGO DESCRIPTION</small>
              <p style="margin: 8px 0; color: #333;">
                {{ trip.cargoDescription|default:"N/A" }}
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Financial Summary Card -->
      <div class="card mb-4" style="border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div class="card-header" style="background-color: #f8f9fa; border-bottom: 2px solid #e9ecef; padding: 20px;">
          <h5 style="color: var(--kamrate-blue); font-weight: 800; margin: 0;">
            üí∞ Financial Summary
          </h5>
        </div>
        <div class="card-body p-4">
          <!-- Trip Revenue -->
          <div class="mb-4 pb-4" style="border-bottom: 1px solid #e9ecef;">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <small class="text-muted" style="font-weight: 700;">TRIP REVENUE</small>
                <h4 style="margin: 8px 0; color: #0D7A3D; font-weight: 800;">‚Ç¶{{ total_revenue|floatformat:0 }}</h4>
              </div>
              <div style="text-align: right; font-weight: 700; color: #0D7A3D;">
                100%
              </div>
            </div>
            <div class="progress" style="height: 8px; background-color: #f0f0f0; border-radius: 4px;">
              <div class="progress-bar" role="progressbar" 
                   style="width: 100%; background-color: #0D7A3D; border-radius: 4px;" 
                   aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">
              </div>
            </div>
          </div>

          <!-- Total Expenses -->
          <div class="mb-4 pb-4" style="border-bottom: 1px solid #e9ecef;">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <small class="text-muted" style="font-weight: 700;">TOTAL EXPENSES</small>
                <h4 style="margin: 8px 0; color: #dc3545; font-weight: 800;">‚Ç¶{{ total_expenses|floatformat:0 }}</h4>
                <small class="text-muted">{{ expenses_count }} expense{% if expenses_count != 1 %}s{% endif %}</small>
              </div>
              <div style="text-align: right; font-weight: 700; color: #dc3545;">
                {{ expense_percentage|floatformat:1 }}%
              </div>
            </div>
            <div class="progress" style="height: 8px; background-color: #f0f0f0; border-radius: 4px;">
              <div class="progress-bar" role="progressbar" 
                   style="width: {{ expense_percentage }}%; background-color: #dc3545; border-radius: 4px;" 
                   aria-valuenow="{{ expense_percentage }}" aria-valuemin="0" aria-valuemax="100">
              </div>
            </div>
          </div>

          <!-- Net Profit/Loss -->
          <div>
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div>
                {% if profit >= 0 %}
                  <small class="text-success" style="font-weight: 700;">NET PROFIT</small>
                  <h4 style="margin: 8px 0; color: #0D7A3D; font-weight: 800;">‚úì ‚Ç¶{{ profit|floatformat:0 }}</h4>
                  <small class="text-success">üòä Profitable Trip</small>
                {% else %}
                  <small class="text-danger" style="font-weight: 700;">TOTAL LOSS</small>
                  <h4 style="margin: 8px 0; color: #dc3545; font-weight: 800;">‚ùå ‚Ç¶{{ profit|floatformat:0 }}</h4>
                  <small class="text-danger">üòû Loss-Making Trip</small>
                {% endif %}
              </div>
              <div style="text-align: right;">
                <p class="text-muted mb-1" style="font-weight: 700;">MARGIN</p>
                <h5 style="margin: 0; color: {% if profit_margin >= 0 %}#0D7A3D{% else %}#dc3545{% endif %}; font-weight: 800;">
                  {{ profit_margin|floatformat:2 }}%
                </h5>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Expenses Section -->
      <div class="card" style="border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div class="card-header" style="background-color: #f8f9fa; border-bottom: 2px solid #e9ecef; padding: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <h5 style="color: var(--kamrate-blue); font-weight: 800; margin: 0;">
              üìã Trip Expenses
            </h5>
            <a href="{% url 'knlInvoice:add-expense' trip.pk %}" class="btn btn-sm btn-primary" style="background-color: var(--kamrate-orange); border-color: var(--kamrate-orange); font-weight: 700;">
              ‚ûï Add Expense
            </a>
          </div>
        </div>

        <div class="card-body p-0">
          {% if expenses %}
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead style="background-color: #f8f9fa; border-bottom: 2px solid #e9ecef;">
                  <tr>
                    <th style="padding: 15px; color: var(--kamrate-blue); font-weight: 800;">Date</th>
                    <th style="padding: 15px; color: var(--kamrate-blue); font-weight: 800;">Category</th>
                    <th style="padding: 15px; color: var(--kamrate-blue); font-weight: 800;">Description</th>
                    <th style="padding: 15px; color: var(--kamrate-blue); font-weight: 800; text-align: right;">Amount</th>
                    <th style="padding: 15px; color: var(--kamrate-blue); font-weight: 800; text-align: center;">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for expense in expenses %}
                  <tr style="border-bottom: 1px solid #e9ecef;">
                    <td style="padding: 15px; color: #333;">{{ expense.date|date:"d M Y" }}</td>
                    <td style="padding: 15px;">
                      <span class="badge" style="background-color: var(--kamrate-orange); color: white; padding: 6px 10px; font-weight: 600;">
                        {{ expense.get_category_display|default:expense.expenseType }}
                      </span>
                    </td>
                    <td style="padding: 15px;">
                      <strong style="color: #333;">{{ expense.description }}</strong>
                      {% if expense.notes %}
                        <br><small class="text-muted">{{ expense.notes }}</small>
                      {% endif %}
                    </td>
                    <td style="padding: 15px; text-align: right;">
                      <strong style="color: #dc3545; font-weight: 800;">‚Ç¶{{ expense.amount|floatformat:0 }}</strong>
                    </td>
                    <td style="padding: 15px; text-align: center;">
                      <div style="display: flex; gap: 5px; justify-content: center;">
                        <a href="{% url 'knlInvoice:edit-expense' trip.pk expense.pk %}" 
                           class="btn btn-sm btn-outline-secondary" title="Edit">
                          ‚úèÔ∏è
                        </a>
                        <form method="post" 
                              action="{% url 'knlInvoice:delete-expense' trip.pk expense.pk %}" 
                              style="display: inline;"
                              onsubmit="return confirm('Delete this expense?');">
                          {% csrf_token %}
                          <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete">
                            üóëÔ∏è
                          </button>
                        </form>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="alert alert-info m-4 p-4" style="border: none; background-color: #d1ecf1; border-radius: 8px;">
              üìã No expenses recorded yet.
              <a href="{% url 'knlInvoice:add-expense' trip.pk %}" class="alert-link" style="font-weight: 700;">Add first expense</a>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Right Column: Summary & Actions (4 cols) -->
    <div class="col-lg-4">
      <!-- Quick Summary Card (Sticky) -->
      <div class="card mb-4" style="border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: sticky; top: 20px;">
        <div class="card-header" style="background-color: #f8f9fa; border-bottom: 2px solid #e9ecef; padding: 20px;">
          <h5 style="color: var(--kamrate-blue); font-weight: 800; margin: 0;">
            üìä Quick Summary
          </h5>
        </div>
        <div class="card-body p-4">
          <!-- Revenue -->
          <div class="mb-4 pb-4" style="border-bottom: 1px solid #e9ecef;">
            <small class="text-muted" style="font-weight: 700;">REVENUE</small>
            <h5 style="margin: 8px 0; color: #0D7A3D; font-weight: 800;">‚Ç¶{{ total_revenue|floatformat:0 }}</h5>
          </div>

          <!-- Expenses -->
          <div class="mb-4 pb-4" style="border-bottom: 1px solid #e9ecef;">
            <small class="text-muted" style="font-weight: 700;">EXPENSES</small>
            <h5 style="margin: 8px 0; color: #dc3545; font-weight: 800;">‚Ç¶{{ total_expenses|floatformat:0 }}</h5>
            <small class="text-muted">{{ expenses_count }} items</small>
          </div>

          <!-- Profit -->
          <div class="mb-4">
            {% if profit >= 0 %}
              <small class="text-success" style="font-weight: 700;">NET PROFIT</small>
              <h5 style="margin: 8px 0; color: #0D7A3D; font-weight: 800;">‚úì ‚Ç¶{{ profit|floatformat:0 }}</h5>
            {% else %}
              <small class="text-danger" style="font-weight: 700;">TOTAL LOSS</small>
              <h5 style="margin: 8px 0; color: #dc3545; font-weight: 800;">‚ùå ‚Ç¶{{ profit|floatformat:0 }}</h5>
            {% endif %}
          </div>

          <!-- Action Buttons -->
          <div style="display: flex; flex-direction: column; gap: 10px;">
            <a href="{% url 'knlInvoice:add-expense' trip.pk %}" 
               class="btn btn-primary" 
               style="background-color: var(--kamrate-orange); border-color: var(--kamrate-orange); font-weight: 700;">
              ‚ûï Add Expense
            </a>
            <a href="{% url 'knlInvoice:expense-list' trip.pk %}" 
               class="btn btn-outline-primary" 
               style="font-weight: 700;">
              üìã All Expenses
            </a>
            <a href="{% url 'knlInvoice:trips-list' %}" 
               class="btn btn-outline-secondary" 
               style="font-weight: 700;">
              ‚Üê Back to Trips
            </a>
          </div>
        </div>
      </div>

      <!-- Status Card -->
      <div class="card" style="border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div class="card-header" style="background-color: #f8f9fa; border-bottom: 2px solid #e9ecef; padding: 20px;">
          <h5 style="color: var(--kamrate-blue); font-weight: 800; margin: 0;">
            ‚ö° Trip Status
          </h5>
        </div>
        <div class="card-body p-4">
          {% if trip.status == 'COMPLETED' %}
            <p class="text-muted mb-2" style="font-weight: 700;">CURRENT STATUS</p>
            <h6 style="margin: 0;">
              <span class="badge" style="background-color: #0D7A3D; color: white; padding: 8px 12px; font-weight: 600;">‚úì Completed</span>
            </h6>
            <small class="text-muted mt-2 d-block">Trip has been successfully completed</small>
          {% elif trip.status == 'IN_PROGRESS' %}
            <p class="text-muted mb-2" style="font-weight: 700;">CURRENT STATUS</p>
            <h6 style="margin: 0;">
              <span class="badge" style="background-color: var(--kamrate-orange); color: white; padding: 8px 12px; font-weight: 600;">‚ü≥ In Progress</span>
            </h6>
            <small class="text-muted mt-2 d-block">Trip is currently active</small>
          {% else %}
            <p class="text-muted mb-2" style="font-weight: 700;">CURRENT STATUS</p>
            <h6 style="margin: 0;">
              <span class="badge" style="background-color: #95a5a6; color: white; padding: 8px 12px; font-weight: 600;">{{ trip.status }}</span>
            </h6>
            <small class="text-muted mt-2 d-block">Trip status: {{ trip.status }}</small>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</main>

<style>
  /* Table styling */
  .table tbody tr:hover {
    background-color: #f8f9fa;
    transition: all 0.2s ease;
  }

  /* Card styling */
  .card {
    border-radius: 8px;
    overflow: hidden;
    transition: all 0.3s ease;
  }

  .card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12) !important;
  }

  /* Button styling */
  .btn {
    border-radius: 5px;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .btn:hover {
    transform: translateY(-2px);
  }

  /* Badge styling */
  .badge {
    border-radius: 4px;
    font-weight: 600;
  }

  /* Progress bar styling */
  .progress {
    border-radius: 4px;
    background-color: #f0f0f0;
    height: 8px;
  }

  /* Responsive adjustments */
  @media (max-width: 992px) {
    .card {
      position: static !important;
    }
  }

  @media (max-width: 768px) {
    .table thead th, .table tbody td {
      padding: 10px 8px !important;
      font-size: 0.85rem;
    }

    .btn-sm {
      padding: 4px 8px !important;
      font-size: 0.75rem;
    }
  }
</style>
{% endblock %}