{% extends 'partials/base.html' %}
{% load static %}

{% block title %}Trip Details - Kamrate Nigeria Limited{% endblock %}

{% block content %}

<div class="container-fluid mt-4">
  <!-- Header Section -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="page-title mb-1">
        <i class="fas fa-truck"></i> {{ trip.tripNumber }}
      </h1>
      <p class="text-muted">
        {{ trip.origin }} → {{ trip.destination }}
      </p>
    </div>
    <div class="btn-group" role="group">
      <a href="{% url 'knlInvoice:trips-list' %}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left"></i> Back to Trips
      </a>
      <a href="{% url 'knlInvoice:trip-edit' trip.pk %}" class="btn btn-warning">
        <i class="fas fa-edit"></i> Edit Trip
      </a>
    </div>
  </div>

  <div class="row">
    <!-- Left: Trip Details (8 columns) -->
    <div class="col-lg-8">
      <!-- Trip Information Card -->
      <div class="card mb-4 shadow-sm" style="border-left: 5px solid #FF9500;">
        <div class="card-header bg-white p-3" style="border-bottom: 2px solid #FF9500;">
          <h5 class="mb-0" style="color: #001f4d; font-weight: 700;">
            <i class="fas fa-info-circle"></i> Trip Information
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <p class="text-muted small">Trip Date</p>
              <h6 style="color: #001f4d; font-weight: 700;">{{ trip.startDate|date:"d M Y" }}</h6>
            </div>
            <div class="col-md-6 mb-3">
              <p class="text-muted small">Trip Status</p>
              <h6>
                {% if trip.status == 'COMPLETED' %}
                  <span class="badge bg-success">COMPLETED</span>
                {% elif trip.status == 'IN_PROGRESS' %}
                  <span class="badge bg-warning">IN PROGRESS</span>
                {% else %}
                  <span class="badge bg-secondary">{{ trip.status }}</span>
                {% endif %}
              </h6>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <p class="text-muted small">Truck</p>
              <h6 style="color: #001f4d; font-weight: 700;">
                {% if trip.truck %}
                  {{ trip.truck.plateNumber }}
                {% else %}
                  Not assigned
                {% endif %}
              </h6>
            </div>
            <div class="col-md-6 mb-3">
              <p class="text-muted small">Cargo Description</p>
              <h6 style="color: #666;">{{ trip.cargoDescription|default:"N/A" }}</h6>
            </div>
          </div>
        </div>
      </div>

      <!-- Financial Summary Card -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-white p-3">
          <h5 class="mb-0" style="color: #001f4d; font-weight: 700;">
            <i class="fas fa-chart-bar"></i> Financial Summary
          </h5>
        </div>
        <div class="card-body">
          <!-- Revenue Row -->
          <div class="row align-items-center mb-4 pb-4 border-bottom">
            <div class="col-md-6">
              <p class="text-muted small mb-1">Trip Revenue</p>
              <h4 style="color: #27ae60; font-weight: 700;">₦{{ total_revenue|floatformat:0 }}</h4>
            </div>
            <div class="col-md-6">
              <div class="progress" style="height: 20px; background-color: #f0f0f0;">
                <div class="progress-bar" role="progressbar" 
                     style="width: 100%; background-color: #27ae60;" 
                     aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">
                </div>
              </div>
            </div>
          </div>

          <!-- Expenses Row -->
          <div class="row align-items-center mb-4 pb-4 border-bottom">
            <div class="col-md-6">
              <p class="text-muted small mb-1">Total Expenses</p>
              <h4 style="color: #e74c3c; font-weight: 700;">₦{{ total_expenses|floatformat:0 }}</h4>
              <small class="text-muted">{{ expenses_count }} expense{% if expenses_count != 1 %}s{% endif %}</small>
            </div>
            <div class="col-md-6">
              <div class="progress" style="height: 20px; background-color: #f0f0f0;">
                <div class="progress-bar" role="progressbar" 
                     style="width: {{ expense_percentage }}%; background-color: #e74c3c;" 
                     aria-valuenow="{{ expense_percentage }}" 
                     aria-valuemin="0" 
                     aria-valuemax="100">
                </div>
              </div>
              <small class="text-muted">{{ expense_percentage|floatformat:1 }}% of revenue</small>
            </div>
          </div>

          <!-- Profit/Loss Row -->
          <div class="row align-items-center">
            <div class="col-md-6">
              <p class="text-muted small mb-1">Net Profit/Loss</p>
              {% if profit >= 0 %}
                <h4 style="color: #27ae60; font-weight: 700;">✅ ₦{{ profit|floatformat:0 }}</h4>
                <small class="text-success">
                  <i class="fas fa-smile"></i> Profitable trip
                </small>
              {% else %}
                <h4 style="color: #e74c3c; font-weight: 700;">❌ -₦{{ profit|floatformat:0 }}</h4>
                <small class="text-danger">
                  <i class="fas fa-frown"></i> Loss-making trip
                </small>
              {% endif %}
            </div>
            <div class="col-md-6">
              <p class="text-muted small mb-1">Profit Margin</p>
              <h5 style="color: {% if profit_margin >= 0 %}#27ae60{% else %}#e74c3c{% endif %}; font-weight: 700;">
                {{ profit_margin|floatformat:2 }}%
              </h5>
            </div>
          </div>
        </div>
      </div>

      <!-- Expenses Section -->
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white p-3">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0" style="color: #001f4d; font-weight: 700;">
              <i class="fas fa-receipt"></i> Trip Expenses
            </h5>
            <a href="{% url 'knlInvoice:add-expense' trip.pk %}" class="btn btn-sm btn-warning">
              <i class="fas fa-plus"></i> Add Expense
            </a>
          </div>
        </div>
        <div class="card-body p-0">
          {% if expenses %}
            <div class="table-responsive">
              <table class="table table-hover mb-0" style="font-size: 13px;">
                <thead style="background-color: #f8f9fa;">
                  <tr>
                    <th style="color: #001f4d; font-weight: 700; padding: 12px;">DATE</th>
                    <th style="color: #001f4d; font-weight: 700; padding: 12px;">CATEGORY</th>
                    <th style="color: #001f4d; font-weight: 700; padding: 12px;">DESCRIPTION</th>
                    <th style="color: #001f4d; font-weight: 700; padding: 12px; text-align: right;">AMOUNT</th>
                    <th style="color: #001f4d; font-weight: 700; padding: 12px; text-align: center;">ACTIONS</th>
                  </tr>
                </thead>
                <tbody>
                  {% for expense in expenses %}
                    <tr>
                      <td style="padding: 12px; color: #666;">{{ expense.date|date:"d M Y" }}</td>
                      <td style="padding: 12px;">
                        <span class="badge" style="background-color: #FF9500; color: white; padding: 5px 10px; font-weight: 600;">
                          {{ expense.get_category_display|default:expense.expenseType }}
                        </span>
                      </td>
                      <td style="padding: 12px; color: #333;">
                        <strong>{{ expense.description }}</strong>
                        {% if expense.notes %}
                          <br><small class="text-muted">{{ expense.notes }}</small>
                        {% endif %}
                      </td>
                      <td style="padding: 12px; text-align: right;">
                        <strong style="color: #e74c3c; font-weight: 700;">₦{{ expense.amount|floatformat:0 }}</strong>
                      </td>
                      <td style="padding: 12px; text-align: center;">
                        <a href="{% url 'knlInvoice:edit-expense' trip.pk expense.pk %}" 
                           class="btn btn-sm btn-outline-warning" title="Edit">
                          <i class="fas fa-edit"></i>
                        </a>
                        <form method="post" 
                              action="{% url 'knlInvoice:delete-expense' trip.pk expense.pk %}" 
                              style="display: inline;"
                              onsubmit="return confirm('Delete this expense?');">
                          {% csrf_token %}
                          <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete">
                            <i class="fas fa-trash"></i>
                          </button>
                        </form>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="alert alert-info m-4">
              <i class="fas fa-info-circle"></i> No expenses recorded yet.
              <a href="{% url 'knlInvoice:add-expense' trip.pk %}" class="alert-link">Add first expense</a>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Right: Quick Actions (4 columns) -->
    <div class="col-lg-4">
      <!-- Summary Card -->
      <div class="card shadow-sm mb-4 sticky-top" style="top: 20px;">
        <div class="card-header bg-white p-3" style="border-bottom: 2px solid #001f4d;">
          <h5 class="mb-0" style="color: #001f4d; font-weight: 700;">
            <i class="fas fa-tachometer-alt"></i> Summary
          </h5>
        </div>
        <div class="card-body">
          <div class="mb-3 pb-3 border-bottom">
            <p class="text-muted small mb-1">Revenue</p>
            <h5 style="color: #27ae60; font-weight: 700;">₦{{ total_revenue|floatformat:0 }}</h5>
          </div>

          <div class="mb-3 pb-3 border-bottom">
            <p class="text-muted small mb-1">Expenses</p>
            <h5 style="color: #e74c3c; font-weight: 700;">₦{{ total_expenses|floatformat:0 }}</h5>
            <small class="text-muted">{{ expenses_count }} items</small>
          </div>

          <div class="mb-4">
            <p class="text-muted small mb-1">Profit</p>
            {% if profit >= 0 %}
              <h5 style="color: #27ae60; font-weight: 700;">✅ ₦{{ profit|floatformat:0 }}</h5>
            {% else %}
              <h5 style="color: #e74c3c; font-weight: 700;">❌ -₦{{ profit|floatformat:0 }}</h5>
            {% endif %}
          </div>

          <div class="d-grid gap-2">
            <a href="{% url 'knlInvoice:add-expense' trip.pk %}" class="btn btn-warning">
              <i class="fas fa-plus-circle"></i> Add Expense
            </a>
            <a href="{% url 'knlInvoice:expense-list' trip.pk %}" class="btn btn-outline-primary">
              <i class="fas fa-list"></i> All Expenses
            </a>
            <a href="{% url 'knlInvoice:trips-list' %}" class="btn btn-outline-secondary">
              <i class="fas fa-arrow-left"></i> Back
            </a>
          </div>
        </div>
      </div>

      <!-- Trip Status Card -->
      <div class="card shadow-sm">
        <div class="card-header bg-white p-3">
          <h5 class="mb-0" style="color: #001f4d; font-weight: 700;">Status</h5>
        </div>
        <div class="card-body">
          <p class="text-muted small mb-2">Current Status</p>
          {% if trip.status == 'COMPLETED' %}
            <h6><span class="badge bg-success">✅ COMPLETED</span></h6>
            <small class="text-muted">Trip has been completed</small>
          {% elif trip.status == 'IN_PROGRESS' %}
            <h6><span class="badge bg-warning">⏳ IN PROGRESS</span></h6>
            <small class="text-muted">Trip is currently active</small>
          {% else %}
            <h6><span class="badge bg-secondary">{{ trip.status }}</span></h6>
            <small class="text-muted">Trip status: {{ trip.status }}</small>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .container-fluid {
    max-width: 60%;
    padding-right: 20px;
    padding-left: 20px;
  }

  .page-title {
    color: #001f4d;
    font-weight: 700;
    font-size: 28px;
  }

  .card {
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid #e0e0e0;
  }

  .table {
    margin-bottom: 0;
  }

  .table tbody tr:hover {
    background-color: #f8f9fa;
  }

  .badge {
    font-weight: 600;
    border-radius: 4px;
    padding: 6px 12px;
  }

  .btn {
    border-radius: 5px;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .btn:hover {
    transform: translateY(-2px);
  }

  .btn-warning {
    background-color: #ff9500 !important;
    border-color: #ff9500 !important;
    color: white !important;
  }

  .btn-outline-warning {
    color: #f39c12;
    border-color: #f39c12;
  }

  .btn-outline-danger {
    color: #e74c3c;
    border-color: #e74c3c;
  }

  .text-muted {
    color: #6c757d;
  }

  .progress {
    border-radius: 4px;
    background-color: #f0f0f0;
  }

  @media (max-width: 992px) {
    .sticky-top {
      position: static !important;
      margin-bottom: 20px;
    }
  }
</style>

{% endblock %}